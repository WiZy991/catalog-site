# Интеграция с 1С - API документация

## Обзор

Реализована интеграция с 1С для автоматического обмена данными о товарах.

## API Endpoint

### POST /api/1c/import

Точка приёма данных из 1С для импорта/обновления товаров.

#### Аутентификация

API использует ключ доступа, который передаётся в заголовке запроса:

```
X-API-Key: ваш-секретный-ключ
```

Или через заголовок Authorization:

```
Authorization: Bearer ваш-секретный-ключ
```

**Важно:** Ключ настраивается в `config/settings.py` через переменную `ONE_C_API_KEY` или переменную окружения `ONE_C_API_KEY`.

#### Поддерживаемые форматы

- **JSON** (по умолчанию)
- **XML**

#### Формат данных JSON

```json
{
  "products": [
    {
      "external_id": "12345",
      "article": "ABC123",
      "brand": "BrandName",
      "name": "Название товара",
      "price": 1000.00,
      "quantity": 5,
      "properties": {
        "key1": "value1",
        "key2": "value2"
      },
      "farpost_url": "https://farpost.ru/...",
      "images": [
        "https://example.com/image1.jpg",
        "https://example.com/image2.jpg"
      ]
    }
  ]
}
```

Или массив напрямую:

```json
[
  {
    "external_id": "12345",
    "article": "ABC123",
    ...
  }
]
```

#### Формат данных XML

```xml
<?xml version="1.0" encoding="UTF-8"?>
<products>
  <product>
    <external_id>12345</external_id>
    <article>ABC123</article>
    <brand>BrandName</brand>
    <name>Название товара</name>
    <price>1000.00</price>
    <quantity>5</quantity>
    <farpost_url>https://farpost.ru/...</farpost_url>
  </product>
</products>
```

#### Обязательные поля

- `external_id` - **ОБЯЗАТЕЛЬНО**. Уникальный идентификатор товара из 1С. Используется для обновления существующих товаров.

#### Опциональные поля

- `article` - Артикул/кросс-номер
- `brand` - Бренд
- `name` - Название товара
- `price` - Цена (число)
- `quantity` - Количество на складе (целое число)
- `properties` - Дополнительные свойства (JSON объект)
- `farpost_url` - Ссылка на Farpost
- `images` - Массив URL изображений

#### Логика обновления

1. **Товар пришёл → обновить**
   - Если товар с таким `external_id` существует, он обновляется
   - Если товара нет, создаётся новый

2. **Товара нет в выгрузке → скрыть**
   - Все товары с `external_id`, которых нет в текущей выгрузке, автоматически скрываются (`is_active=False`)
   - Скрываются только товары, которые были импортированы из 1С (имеют `external_id`)

3. **Дубликаты → запретить**
   - Поле `external_id` уникально в базе данных
   - Попытка создать товар с существующим `external_id` приведёт к обновлению существующего товара

#### Ответ API

**Успешный ответ (200 OK):**

```json
{
  "success": true,
  "total": 100,
  "updated": 80,
  "created": 20,
  "hidden": 5,
  "errors_count": 0
}
```

**Ответ с ошибками (207 Multi-Status):**

```json
{
  "success": true,
  "total": 100,
  "updated": 80,
  "created": 15,
  "hidden": 5,
  "errors_count": 5,
  "errors": [
    "Товар #1: отсутствует external_id",
    "Товар #5: неверный формат цены"
  ]
}
```

**Ошибка авторизации (401 Unauthorized):**

```json
{
  "error": "Неверный API ключ"
}
```

**Ошибка парсинга (400 Bad Request):**

```json
{
  "error": "Ошибка парсинга JSON: ..."
}
```

## Модель товара

### Обязательные поля для интеграции с 1С

- `external_id` - ID из 1С (уникальный, индексированный)
- `article` - Артикул
- `brand` - Бренд
- `price` - Цена
- `quantity` - Количество
- `properties` - Дополнительные свойства (JSON)
- `farpost_url` - Ссылка на Farpost
- `images[]` - Изображения (через модель ProductImage)

**Важно:** Обновление товаров происходит по `external_id`, а не по названию!

## Логирование

Все обмены с 1С логируются в модель `OneCExchangeLog`, доступную в админ-панели Django.

Логи содержат:
- Метод и путь запроса
- IP адрес клиента
- Формат данных (JSON/XML)
- Статус обработки
- Статистику (сколько товаров обновлено/создано/скрыто)
- Ошибки (если есть)
- Время обработки

## Настройка

1. **Установите API ключ** в `config/settings.py`:

```python
ONE_C_API_KEY = 'ваш-секретный-ключ-здесь'
```

Или через переменную окружения:

```bash
export ONE_C_API_KEY='ваш-секретный-ключ-здесь'
```

2. **Выполните миграции:**

```bash
python manage.py migrate
```

3. **Проверьте работу API:**

```bash
curl -X POST http://your-domain.com/api/1c/import \
  -H "X-API-Key: ваш-секретный-ключ" \
  -H "Content-Type: application/json" \
  -d '{"products": [{"external_id": "test123", "name": "Test Product", "price": 100}]}'
```

## Пример использования из 1С

### HTTP-запрос из 1С

```1c
Запрос = Новый HTTPСоединение("your-domain.com", 443, , , , 30, Новый ЗащищенноеСоединениеOpenSSL);
Заголовки = Новый Соответствие;
Заголовки["X-API-Key"] = "ваш-секретный-ключ";
Заголовки["Content-Type"] = "application/json";

ДанныеJSON = ПолучитьJSONИзТоваров(); // Ваша функция формирования JSON

Ответ = Запрос.ОтправитьДляОбработки("POST", "/api/1c/import", Заголовки, ДанныеJSON);
```

## Безопасность

- Используйте HTTPS в продакшене
- Храните API ключ в переменных окружения, а не в коде
- Регулярно проверяйте логи обменов в админ-панели
- Настройте ограничение по IP адресам при необходимости (можно добавить в `api_views.py`)

