# Техническая документация API интеграции 1С с Django сайтом

## Для программиста 1С

---

## Общая информация

**Базовый URL:** `https://your-site.com` (замените на ваш домен)

**Метод аутентификации:** Токен авторизации (передается в заголовке или в теле запроса)

**Форматы данных:** JSON

**Кодировка:** UTF-8

---

## Endpoint 1: API синхронизация товаров

**URL:** `/api/1c/sync/`

**Метод:** `POST`

**Content-Type:** `application/json; charset=utf-8`

**Аутентификация:**
- В заголовке: `X-API-Key: ваш-токен`
- Или в теле запроса: поле `token` со значением токена

---

## Структура запроса

### Корневой объект

```json
{
  "token": "строка",
  "products": [массив товаров]
}
```

### Поля корневого объекта

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `token` | String | Да | Токен авторизации (должен совпадать с токеном на сервере) |
| `products` | Array | Да | Массив объектов товаров (минимум 1 товар) |

---

## Структура объекта товара

### Обязательные поля

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| `sku` | String | Артикул товара (уникальный идентификатор) | Максимум 100 символов. Используется для поиска существующего товара. Если товар с таким артикулом существует - он обновится, если нет - создастся новый |
| `name` | String | Название товара | Максимум 500 символов |
| `price` | Decimal/Number | Цена товара | Должна быть >= 0. Разделитель дробной части - точка (.) |

### Опциональные поля

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| `description` | String | Полное описание товара | Текст любой длины |
| `old_price` | Decimal/Number | Старая цена (для отображения скидки) | Должна быть >= 0 и > `price`. Разделитель дробной части - точка (.) |
| `stock` | Integer | Остаток на складе | Должен быть >= 0. По умолчанию: 0 |
| `category` | String | Название категории | Максимум 200 символов. Если категория не существует - она будет создана автоматически |
| `characteristics` | Array | Массив характеристик товара | Каждый элемент - объект с полями `name` и `value` |
| `is_active` | Boolean | Активен ли товар | `true` или `false`. По умолчанию: `true` |

---

## Структура характеристики товара

Если указано поле `characteristics`, каждый элемент массива должен быть объектом:

| Поле | Тип | Обязательное | Описание | Ограничения |
|------|-----|--------------|----------|-------------|
| `name` | String | Да | Название характеристики | Максимум 200 символов |
| `value` | String | Да | Значение характеристики | Максимум 500 символов |

**Примечание:** При обновлении товара все старые характеристики удаляются и заменяются новыми из запроса.

---

## Типы данных

### String (Строка)
- Текст в кодировке UTF-8
- Может быть пустой строкой `""` для опциональных полей
- Не может быть `null` для обязательных полей

### Decimal/Number (Число с дробной частью)
- Формат: число с точкой как разделителем (например: `1000.50`)
- Не используйте запятую как разделитель
- Может быть целым числом (например: `1000`)
- Минимальное значение: `0`

### Integer (Целое число)
- Целое число без дробной части
- Минимальное значение: `0`
- Примеры: `0`, `10`, `100`

### Boolean (Логическое значение)
- `true` или `false`
- В JSON: без кавычек
- Не используйте строки `"true"` или `"false"`, числа `1` или `0`

### Array (Массив)
- Список элементов в квадратных скобках `[]`
- Может быть пустым `[]`
- Элементы разделяются запятой

---

## Примеры запросов

### Пример 1: Минимальный запрос (только обязательные поля)

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00
    }
  ]
}
```

### Пример 2: Полный запрос со всеми полями

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "description": "Подробное описание товара",
      "price": 1000.00,
      "old_price": 1500.00,
      "stock": 10,
      "category": "Категория 1",
      "characteristics": [
        {
          "name": "Цвет",
          "value": "Красный"
        },
        {
          "name": "Материал",
          "value": "Металл"
        },
        {
          "name": "Размер",
          "value": "10x20x5 см"
        }
      ],
      "is_active": true
    }
  ]
}
```

### Пример 3: Массовая отправка товаров

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00,
      "stock": 5
    },
    {
      "sku": "ART002",
      "name": "Товар 2",
      "price": 2000.00,
      "stock": 10,
      "category": "Категория 2"
    },
    {
      "sku": "ART003",
      "name": "Товар 3",
      "price": 3000.00,
      "old_price": 3500.00,
      "stock": 0,
      "is_active": false
    }
  ]
}
```

---

## Структура ответа

### Успешный ответ (HTTP 200)

```json
{
  "status": "success",
  "processed": 10,
  "created": 3,
  "updated": 7,
  "errors": []
}
```

**Поля ответа:**

| Поле | Тип | Описание |
|------|-----|----------|
| `status` | String | Статус обработки: `"success"`, `"partial"` или `"error"` |
| `processed` | Integer | Общее количество товаров в запросе |
| `created` | Integer | Количество созданных товаров |
| `updated` | Integer | Количество обновленных товаров |
| `errors` | Array | Массив ошибок (пустой при успехе) |

### Частичный успех (HTTP 207)

```json
{
  "status": "partial",
  "processed": 10,
  "created": 3,
  "updated": 5,
  "errors": [
    "Товар #3: Ошибка валидации: цена обязательна",
    "Товар #7: Ошибка валидации: артикул обязателен"
  ]
}
```

**Когда возникает:** Часть товаров обработана успешно, но есть ошибки в других товарах.

### Ошибка (HTTP 400, 401, 500)

```json
{
  "status": "error",
  "message": "Описание ошибки",
  "errors": []
}
```

**HTTP коды ошибок:**

| Код | Описание |
|-----|----------|
| 400 | Ошибка валидации данных (неверный формат, отсутствуют обязательные поля) |
| 401 | Неверный токен авторизации |
| 500 | Внутренняя ошибка сервера |

---

## Правила валидации

### Обязательные поля
- `token` - должен присутствовать и совпадать с токеном на сервере
- `products` - должен быть массивом с минимум одним элементом
- В каждом товаре: `sku`, `name`, `price`

### Валидация цен
- `price` должна быть >= 0
- `old_price` (если указана) должна быть >= 0 и > `price`
- Разделитель дробной части - точка (`.`), не запятая

### Валидация остатков
- `stock` должен быть >= 0
- Если не указан, используется значение `0`

### Валидация характеристик
- Если указано поле `characteristics`, оно должно быть массивом
- Каждый элемент массива должен иметь поля `name` и `value`
- `name` не может быть пустым
- `value` не может быть пустым

### Валидация категории
- Если указана категория, она будет создана автоматически, если не существует
- Название категории обрезается до 200 символов

---

## Логика обработки товаров

### Поиск товара
- Товар ищется по полю `sku` (артикул)
- Если товар с таким артикулом существует - он обновляется
- Если товар не найден - создается новый

### Обновление полей
- Все указанные поля обновляются
- Поля, которые не указаны в запросе, остаются без изменений (кроме характеристик)
- Характеристики полностью заменяются (старые удаляются, новые создаются)

### Обновление наличия
- Если `stock > 0` → статус наличия: "В наличии"
- Если `stock = 0` → статус наличия: "Нет в наличии"

### Обработка категории
- Если категория указана и существует - товар привязывается к ней
- Если категория указана, но не существует - категория создается автоматически
- Если категория не указана - товар остается без категории

---

## Ограничения

### Размер запроса
- Максимальное количество товаров в одном запросе: рекомендуется до 1000 товаров
- При большом количестве товаров разбейте запрос на несколько частей

### Длина полей
- `sku`: максимум 100 символов
- `name`: максимум 500 символов
- `description`: без ограничений
- `category`: максимум 200 символов
- `characteristics.name`: максимум 200 символов
- `characteristics.value`: максимум 500 символов

### Производительность
- Время обработки зависит от количества товаров
- Рекомендуется отправлять не более 100-200 товаров за раз
- Для больших объемов используйте несколько запросов

---

## Обработка ошибок

### Типы ошибок

1. **Ошибка авторизации (401)**
   - Причина: неверный токен
   - Решение: проверьте токен в запросе и на сервере

2. **Ошибка валидации (400)**
   - Причина: неверный формат данных, отсутствуют обязательные поля
   - Решение: проверьте структуру запроса и типы данных

3. **Ошибка обработки товара**
   - Причина: ошибка в данных конкретного товара
   - Решение: товар пропускается, остальные обрабатываются. Проверьте ошибки в ответе

### Рекомендации по обработке ошибок

1. Всегда проверяйте HTTP код ответа
2. Если код 200 или 207 - проверьте массив `errors` в ответе
3. Если есть ошибки - логируйте их для последующего исправления
4. При ошибке валидации конкретного товара - остальные товары все равно обрабатываются

---

## Endpoint 2: Загрузка файлов

**URL:** `/api/1c/upload/`

**Метод:** `POST`

**Content-Type:** `multipart/form-data`

**Аутентификация:**
- В заголовке: `X-API-Key: ваш-токен`

### Параметры запроса

| Параметр | Тип | Обязательное | Описание |
|----------|-----|--------------|----------|
| `file` | File | Да | Файл для загрузки (CSV, XML или JSON) |

### Поддерживаемые форматы файлов

1. **CSV** (`.csv`)
   - Разделитель: запятая
   - Кодировка: UTF-8 или CP1251
   - Первая строка: заголовки колонок

2. **XML** (`.xml`)
   - Кодировка: UTF-8
   - Структура: элементы `<product>` или `<товар>`

3. **JSON** (`.json`)
   - Кодировка: UTF-8
   - Формат: массив товаров или объект с полем `products`

### Формат ответа

Аналогичен endpoint `/api/1c/sync/` (см. выше)

---

## Маппинг полей для CSV

При загрузке CSV файла используются следующие названия колонок (регистронезависимо):

| Название колонки в CSV | Поле в системе |
|------------------------|----------------|
| `sku`, `артикул`, `article` | `sku` |
| `name`, `название`, `наименование` | `name` |
| `description`, `описание` | `description` |
| `price`, `цена` | `price` |
| `old_price`, `старая_цена` | `old_price` |
| `stock`, `остаток`, `количество` | `stock` |
| `category`, `категория` | `category` |
| `is_active`, `активен` | `is_active` |

**Примечание:** Остальные колонки будут интерпретированы как характеристики (название колонки = название характеристики, значение = значение характеристики).

---

## Маппинг полей для XML

При загрузке XML файла используются следующие теги:

| Тег в XML | Поле в системе |
|-----------|----------------|
| `<sku>`, `<артикул>`, `<article>` | `sku` |
| `<name>`, `<название>`, `<наименование>` | `name` |
| `<description>`, `<описание>` | `description` |
| `<price>`, `<цена>` | `price` |
| `<old_price>`, `<старая_цена>` | `old_price` |
| `<stock>`, `<остаток>`, `<количество>` | `stock` |
| `<category>`, `<категория>` | `category` |
| `<is_active>`, `<активен>` | `is_active` |

**Структура XML:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<products>
  <product>
    <sku>ART001</sku>
    <name>Товар 1</name>
    <price>1000.00</price>
    <stock>10</stock>
  </product>
  <product>
    <sku>ART002</sku>
    <name>Товар 2</name>
    <price>2000.00</price>
  </product>
</products>
```

---

## Рекомендации по использованию

### Для регулярной синхронизации

1. Отправляйте только измененные товары (по дате изменения)
2. Группируйте товары по категориям для лучшей производительности
3. Используйте batch-обработку (не более 100-200 товаров за раз)

### Для полной синхронизации

1. Разбейте все товары на части (по 100-200 штук)
2. Отправляйте каждую часть отдельным запросом
3. Проверяйте ответы и логируйте ошибки

### Для обработки ошибок

1. Сохраняйте ответы API для анализа
2. При ошибках валидации - исправляйте данные и отправляйте повторно
3. Используйте логи на сервере для диагностики проблем

---

## Контрольный список перед отправкой

- [ ] Токен авторизации указан и корректен
- [ ] Поле `products` присутствует и является массивом
- [ ] В каждом товаре указаны обязательные поля: `sku`, `name`, `price`
- [ ] Типы данных соответствуют требованиям:
  - [ ] `price` - число (не строка)
  - [ ] `stock` - целое число (не строка)
  - [ ] `is_active` - логическое значение (не строка)
- [ ] `price` >= 0
- [ ] Если указан `old_price`, то `old_price` > `price`
- [ ] `stock` >= 0
- [ ] Если указаны `characteristics`, то каждый элемент имеет `name` и `value`
- [ ] Кодировка запроса: UTF-8
- [ ] Content-Type: `application/json; charset=utf-8`

---

## Дополнительная информация

### Логирование на сервере

Все запросы логируются в админ-панели Django:
- Раздел: `Catalog` → `Sync logs`
- Доступ: `/admin/catalog/synclog/`

В логах сохраняется:
- Дата и время запроса
- IP адрес отправителя
- Количество обработанных товаров
- Список ошибок (если есть)
- Время обработки

### Уведомления об ошибках

При наличии ошибок система автоматически отправляет email администратору (если настроен `MANAGER_EMAIL` в настройках сервера).

---

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи синхронизации в админ-панели
2. Проверьте формат данных запроса
3. Убедитесь, что токен авторизации корректен
4. Обратитесь к администратору сайта с описанием проблемы
