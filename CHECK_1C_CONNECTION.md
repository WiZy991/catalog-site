# Проверка подключения 1С к сайту

## Проблема
Запросы от 1С не доходят до Django - нет логов синхронизации и файлы не сохраняются.

## Шаг 1: Проверка доступности endpoint

### Тестовый endpoint
Добавлен тестовый endpoint для проверки доступности:
```
http://onesim8n.beget.tech/cml/test/
```

**Проверьте в браузере:**
1. Откройте: `http://onesim8n.beget.tech/cml/test/`
2. Должно появиться: `OK - CommerceML endpoint доступен`
3. Если не открывается → проблема с доступностью сайта или маршрутизацией

### Основной endpoint
```
http://onesim8n.beget.tech/cml/exchange?type=catalog&mode=checkauth
```

**Проверьте в браузере:**
1. Откройте этот URL
2. Должно появиться: `failure\nОшибка авторизации` (это нормально, т.к. нет авторизации в браузере)
3. Если не открывается → проблема с URL или маршрутизацией

## Шаг 2: Проверка URL в настройках 1С

### Правильный формат URL:
```
http://onesim8n.beget.tech/cml/exchange?type=catalog&mode=checkauth
```

**Важно:**
- После `exchange` должен быть либо `/`, либо сразу `?`
- Не должно быть лишних слэшей
- Должен быть протокол `http://` или `https://`

### Проверка в 1С:
1. Зайдите в настройки узла обмена
2. Нажмите **"Проверить соединение..."**
3. Должно появиться: **"Соединение успешно установлено"**
4. Если ошибка → проверьте URL и доступность сайта

## Шаг 3: Проверка логов

### Файл логов CommerceML
Все запросы теперь логируются в файл:
```
logs/commerceml_requests.log
```

**Проверьте:**
1. Откройте файл `logs/commerceml_requests.log`
2. Если файл пустой или нет записей → запросы не доходят до Django
3. Если есть записи → запросы доходят, но могут быть проблемы с авторизацией

### Логи Django
Проверьте файл:
```
logs/django.log
```

Ищите строки:
- `MIDDLEWARE: CommerceML запрос получен`
- `CommerceML запрос получен!`

## Шаг 4: Диагностика проблем

### Проблема 1: Тестовый endpoint не открывается

**Возможные причины:**
- Сайт не запущен
- Проблемы с веб-сервером (nginx/apache)
- Проблемы с маршрутизацией на Beget

**Решение:**
1. Проверьте, что Django запущен
2. Проверьте логи веб-сервера
3. Проверьте настройки на Beget

### Проблема 2: Тестовый endpoint открывается, но основной не работает

**Возможные причины:**
- Неправильный URL в 1С
- Проблемы с параметрами запроса
- Проблемы с авторизацией

**Решение:**
1. Проверьте URL в настройках 1С
2. Проверьте логи `commerceml_requests.log`
3. Попробуйте открыть основной endpoint в браузере

### Проблема 3: Запросы доходят, но файлы не сохраняются

**Возможные причины:**
- Проблемы с правами доступа к директории `media/1c_exchange/`
- Ошибки при сохранении файлов
- Файлы сохраняются, но сразу удаляются

**Решение:**
1. Проверьте права доступа к `media/1c_exchange/`
2. Проверьте логи на ошибки сохранения
3. Проверьте, что директория существует

## Шаг 5: Проверка на сервере Beget

### Проверка директории
```bash
ls -la media/1c_exchange/
```

Должна существовать директория, даже если она пустая.

### Проверка прав доступа
```bash
chmod 755 media/
chmod 755 media/1c_exchange/
```

### Проверка логов
```bash
tail -f logs/commerceml_requests.log
tail -f logs/django.log
```

## Шаг 6: Тестирование из 1С

1. **Проверка подключения:**
   - В 1С нажмите "Проверить соединение..."
   - Должно быть: "Соединение успешно установлено"

2. **Выполнение обмена:**
   - Нажмите "Выполнить обмен данными"
   - Сразу после этого проверьте:
     - Файл `logs/commerceml_requests.log` - должны появиться записи
     - Файл `logs/django.log` - должны появиться записи
     - Директорию `media/1c_exchange/` - должны появиться файлы

## Чек-лист диагностики

- [ ] Тестовый endpoint `/cml/test/` открывается в браузере
- [ ] Основной endpoint `/cml/exchange?type=catalog&mode=checkauth` открывается (даже с ошибкой авторизации)
- [ ] В 1С проверка подключения проходит успешно
- [ ] Файл `logs/commerceml_requests.log` создается и содержит записи
- [ ] Файл `logs/django.log` содержит записи о CommerceML запросах
- [ ] Директория `media/1c_exchange/` существует
- [ ] Права доступа к директории правильные (755)
- [ ] После обмена в 1С появляются записи в логах
- [ ] После обмена в 1С появляются файлы в `media/1c_exchange/`

## Если ничего не помогает

1. **Проверьте настройки на Beget:**
   - Может быть блокировка запросов от определенных IP
   - Может быть проблема с прокси/балансировщиком
   - Может быть проблема с SSL/HTTPS

2. **Проверьте логи веб-сервера:**
   - Nginx: `/var/log/nginx/error.log`
   - Apache: `/var/log/apache2/error.log`

3. **Попробуйте прямой доступ:**
   - Откройте URL из 1С в браузере на сервере
   - Проверьте, что запросы доходят до Django

4. **Проверьте настройки Django:**
   - `ALLOWED_HOSTS` должен содержать домен или `'*'`
   - `DEBUG` должен быть `True` для диагностики
   - Проверьте настройки логирования

## Контакты для помощи

Если проблема сохраняется, пришлите:
1. Скриншот настроек узла обмена в 1С (с URL)
2. Содержимое файла `logs/commerceml_requests.log` (последние 50 строк)
3. Содержимое файла `logs/django.log` (последние 50 строк)
4. Результат проверки подключения в 1С
