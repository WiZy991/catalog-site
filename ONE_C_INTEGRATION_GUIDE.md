# Руководство по интеграции 1С с Django сайтом

## Обзор

Создана полноценная система интеграции 1С с Django сайтом для синхронизации товаров. Система поддерживает:
- Прием файлов от 1С (CSV, XML, JSON) через загрузку файлов
- API endpoint для приема данных от 1С в формате JSON (POST запрос)
- Создание и обновление товаров в базе данных
- Обновление характеристик, цен, остатков на складе
- Безопасность: токен авторизации, валидация данных
- Логирование всех операций синхронизации
- Обработка ошибок и отчет о результатах

## Установка

1. **Выполните миграции:**
```bash
python manage.py makemigrations
python manage.py migrate
```

2. **Настройте токен авторизации в `config/settings.py`:**
```python
ONE_C_API_KEY = 'ваш-секретный-токен-здесь'
```

Или через переменную окружения:
```bash
export ONE_C_API_KEY='ваш-секретный-токен-здесь'
```

## API Endpoints

### 1. Загрузка файлов: `/api/1c/upload/`

**Метод:** POST  
**Content-Type:** multipart/form-data  
**Параметры:**
- `file` - файл для загрузки (CSV, XML или JSON)
- Заголовок `X-API-Key` или `Authorization: Bearer <токен>` - токен авторизации

**Поддерживаемые форматы:**
- CSV
- XML
- JSON

**Пример запроса (curl):**
```bash
curl -X POST http://your-domain.com/api/1c/upload/ \
  -H "X-API-Key: ваш-секретный-токен" \
  -F "file=@products.csv"
```

### 2. API синхронизация: `/api/1c/sync/`

**Метод:** POST  
**Content-Type:** application/json  
**Заголовки:**
- `X-API-Key: ваш-секретный-токен` или
- `Authorization: Bearer ваш-секретный-токен`

**Формат данных (JSON):**
```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "description": "Описание товара",
      "price": 1000.00,
      "old_price": 1500.00,
      "stock": 10,
      "category": "Категория 1",
      "characteristics": [
        {"name": "Цвет", "value": "Красный"},
        {"name": "Материал", "value": "Металл"}
      ],
      "is_active": true
    }
  ]
}
```

**Пример запроса (curl):**
```bash
curl -X POST http://your-domain.com/api/1c/sync/ \
  -H "Content-Type: application/json" \
  -H "X-API-Key: ваш-секретный-токен" \
  -d '{
    "token": "ваш-секретный-токен",
    "products": [
      {
        "sku": "ART001",
        "name": "Товар 1",
        "price": 1000.00,
        "stock": 10
      }
    ]
  }'
```

## Формат ответа

**Успешный ответ (200 OK):**
```json
{
  "status": "success",
  "processed": 10,
  "created": 3,
  "updated": 7,
  "errors": []
}
```

**Частичный успех (207 Multi-Status):**
```json
{
  "status": "partial",
  "processed": 10,
  "created": 3,
  "updated": 5,
  "errors": [
    "Товар #3: Ошибка валидации: цена обязательна"
  ]
}
```

**Ошибка (400/401/500):**
```json
{
  "status": "error",
  "message": "Описание ошибки",
  "errors": []
}
```

## Структура данных товара

### Обязательные поля:
- `sku` (string) - Артикул товара (уникальный идентификатор)

### Опциональные поля:
- `name` (string) - Название товара
- `description` (string) - Описание товара
- `price` (decimal) - Цена товара
- `old_price` (decimal) - Старая цена (для отображения скидки)
- `stock` (integer) - Остаток на складе
- `category` (string) - Название категории (будет создана автоматически, если не существует)
- `characteristics` (array) - Массив характеристик:
  ```json
  [
    {"name": "Название характеристики", "value": "Значение"}
  ]
  ```
- `is_active` (boolean) - Активен ли товар (по умолчанию `true`)

## Логирование

Все операции синхронизации логируются в модель `SyncLog`. Логи доступны в админ-панели Django:
- `/admin/catalog/synclog/`

Логи содержат:
- Тип операции (загрузка файла или API синхронизация)
- Статус (успешно, частично, ошибка)
- Количество обработанных, созданных и обновленных товаров
- Список ошибок
- IP адрес запроса
- Время обработки

## Обработка ошибок

Система автоматически:
- Валидирует все входящие данные
- Обрабатывает ошибки и продолжает работу с остальными товарами
- Отправляет email уведомления менеджеру при наличии ошибок (если настроен `MANAGER_EMAIL` в settings.py)
- Логирует все ошибки для последующего анализа

## Безопасность

1. **Токен авторизации:** Все запросы должны содержать валидный токен
2. **Валидация данных:** Все данные проходят строгую валидацию перед обработкой
3. **Транзакции:** Все операции выполняются в транзакциях для обеспечения целостности данных
4. **Логирование IP:** Все запросы логируются с IP адресом

## Пример использования из 1С

### HTTP-запрос из 1С:

```1c
Запрос = Новый HTTPСоединение("your-domain.com", 443, , , , 30, Новый ЗащищенноеСоединениеOpenSSL);
Заголовки = Новый Соответствие;
Заголовки["X-API-Key"] = "ваш-секретный-токен";
Заголовки["Content-Type"] = "application/json";

ДанныеJSON = ПолучитьJSONИзТоваров(); // Ваша функция формирования JSON

Ответ = Запрос.ОтправитьДляОбработки("POST", "/api/1c/sync/", Заголовки, ДанныеJSON);
```

## Модели базы данных

### ProductCharacteristic
Характеристики товара (название, значение, связь с товаром)

### SyncLog
Лог синхронизации (дата, тип операции, статус, сообщение, количество обработанных товаров)

## Дополнительные возможности

- **Обработка дубликатов:** Товары с одинаковым артикулом автоматически обновляются
- **Автоматическое создание категорий:** Категории создаются автоматически, если не существуют
- **Обновление характеристик:** Старые характеристики удаляются и заменяются новыми
- **Обновление наличия:** Автоматическое обновление статуса наличия на основе остатка

## Поддержка

При возникновении проблем проверьте:
1. Правильность токена авторизации
2. Формат данных (соответствие JSON схеме)
3. Логи синхронизации в админ-панели
4. Настройки email для уведомлений об ошибках
