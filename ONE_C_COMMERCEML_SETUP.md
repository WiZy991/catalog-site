# Настройка обмена с 1С через стандартный протокол CommerceML 2

## Описание

Система поддерживает стандартный протокол обмена CommerceML 2, разработанный компаниями «1С» и «1С-Битрикс». Этот протокол используется штатной процедурой обмена коммерческими данными между системой «1С: Предприятие» и сайтом.

## URL для обмена

Система поддерживает два варианта URL:

1. **Стандартный формат:** `http://ваш-сайт.com/cml/exchange/`
2. **Формат для совместимости:** `http://ваш-сайт.com/1c_exchange.php`

Оба URL работают одинаково.

⚠️ **Важно:** В стандартном формате обязательно должен быть слэш в конце (`/`).

## Настройка в 1С

### Шаг 1: Включение обмена данными

1. В 1С перейдите в **Администрирование** → **Обмен данными**
2. Отметьте флажок **"Обмен данными с сайтами"**

### Шаг 2: Создание узла обмена

1. Перейдите в **Администрирование** → **Обмен данными** → **Узлы обмена с сайтами**
2. Нажмите кнопку **"Создать"**

### Шаг 3: Настройка параметров обмена

В форме узла обмена заполните:

- **Наименование:** Любое название (например, "Обмен с сайтом")
- **Выгрузка товаров:** Отметьте флажок
- **Обмен заказами:** Отметьте, если нужен обмен заказами
- **Адрес сайта:** `http://ваш-сайт.com/cml/exchange/?type=catalog&mode=checkauth`
  - ⚠️ **Важно:** 
    - Обязательно должен быть слэш перед `?` (`/cml/exchange/`)
    - После `checkauth` не должно быть лишних символов
- **Имя пользователя:** Логин администратора Django
- **Пароль:** Пароль администратора Django

### Шаг 4: Проверка соединения

1. Нажмите кнопку **"Проверить соединение..."**
2. Если все параметры указаны верно, появится сообщение **"Соединение успешно установлено"**

### Шаг 5: Настройка выгрузки товаров

1. Перейдите на вкладку **"Выгрузка товаров"**
2. Укажите:
   - **Организация** - владелец каталога
   - **Выгружать файлы изображений** - если нужны картинки
   - **Классифицировать по видам номенклатуры** - по необходимости
3. В таблице каталогов укажите:
   - **Каталог** - имя каталога
   - **Группы номенклатуры** - какие группы выгружать
   - **Идентификатор каталога** - идентификатор для связи с сайтом

### Шаг 6: Выполнение обмена

1. Нажмите кнопку **"Выполнить обмен данными"**
2. Дождитесь завершения обмена
3. Проверьте результаты в админ-панели Django: **Catalog** → **Sync logs**

## Протокол обмена

### Режим A: checkauth (Проверка авторизации)

**Запрос:**
```
GET /cml/exchange/?type=catalog&mode=checkauth
Authorization: Basic <base64(логин:пароль)>
```

**Ответ (успех):**
```
success
1c_exchange_session
<значение_cookie>
```

**Ответ (ошибка):**
```
failure
Ошибка авторизации
```

### Режим B: init (Получение параметров)

**Запрос:**
```
GET /cml/exchange/?type=catalog&mode=init
Cookie: 1c_exchange_session=<значение>
```

**Ответ:**
```
zip=yes
file_limit=104857600
```

### Режим C: file (Загрузка файла)

**Запрос:**
```
POST /cml/exchange/?type=catalog&mode=file&filename=import0_1.xml
Cookie: 1c_exchange_session=<значение>
Content-Type: application/xml

<содержимое XML файла>
```

**Ответ (успех):**
```
success
```

**Ответ (ошибка):**
```
failure
Описание ошибки
```

### Режим D: import (Импорт данных)

**Запрос:**
```
GET /cml/exchange/?type=catalog&mode=import&filename=import0_1.xml
Cookie: 1c_exchange_session=<значение>
```

**Ответ (успех):**
```
success
```

**Ответ (в процессе):**
```
progress
Обработка файла...
```

**Ответ (ошибка):**
```
failure
Описание ошибки
```

## Формат CommerceML 2

Система обрабатывает XML файлы в формате CommerceML 2. Основные элементы:

- **Каталог** - корневой элемент каталога товаров
- **Товар** - элемент товара
  - **Ид** - уникальный идентификатор товара (используется как `external_id` и `sku`)
  - **Артикул** - артикул товара
  - **Наименование** - название товара
  - **Описание** - описание товара
  - **Группы** - категории товара
  - **ЗначенияСвойств** - характеристики товара

## Маппинг полей

| Поле CommerceML 2 | Поле Django | Описание |
|-------------------|-------------|----------|
| `Ид` | `external_id`, `sku` | Уникальный идентификатор |
| `Артикул` | `article`, `sku` | Артикул товара |
| `Наименование` | `name` | Название товара |
| `Описание` | `description` | Описание товара |
| `ЦенаЗаЕдиницу` | `price` | Цена товара |
| `Количество` | `quantity` (stock) | Остаток на складе |
| `Группы/Ид` | `category` | Категория товара |
| `ЗначенияСвойств` | `characteristics` | Характеристики товара |

## Логика обработки товаров

1. **Поиск товара:**
   - Сначала ищется по `external_id` (из поля `Ид`)
   - Если не найден, ищется по `article` (из поля `Артикул`)
   - Если не найден, создается новый товар

2. **Обновление товара:**
   - Все указанные поля обновляются
   - Характеристики полностью заменяются (старые удаляются, новые создаются)
   - При обновлении устанавливается `external_id`, если его не было

3. **Создание товара:**
   - Создается новый товар с `external_id=Ид` и `article=Артикул` (или `Ид`, если артикула нет)

## Логирование

Все операции обмена логируются в админ-панели Django:

- **Раздел:** `Catalog` → `Sync logs`
- **Информация в логах:**
  - Дата и время запроса
  - IP адрес отправителя
  - Тип операции (file_upload)
  - Количество обработанных товаров
  - Количество созданных товаров
  - Количество обновленных товаров
  - Список ошибок (если есть)
  - Время обработки

## Настройка на сервере

### Переменные окружения (опционально)

В `config/settings.py` можно настроить:

```python
# Директория для временного хранения файлов обмена
ONE_C_EXCHANGE_DIR = os.path.join(MEDIA_ROOT, '1c_exchange')

# Максимальный размер файла (в байтах)
ONE_C_FILE_LIMIT = 104857600  # 100 MB

# Поддержка ZIP сжатия
ONE_C_SUPPORT_ZIP = True
```

## Автоматический обмен

Для автоматического обмена в 1С:

1. В форме узла обмена отметьте флажок **"Использовать периодический обмен данными"**
2. Настройте расписание обмена
3. Сохраните настройки

Обмен будет происходить автоматически по расписанию.

## Устранение неполадок

### Ошибка авторизации

- Проверьте логин и пароль администратора Django
- Убедитесь, что пользователь имеет права администратора (`is_staff=True`)

### Ошибка "Сессия недействительна"

- Проверьте, что Cookie передаются в запросах
- Убедитесь, что кеш Django работает (для хранения сессий)

### Ошибка "Файл не найден"

- Проверьте, что файл был успешно загружен на предыдущем шаге (режим `file`)
- Убедитесь, что имя файла совпадает

### Ошибка парсинга XML

- Проверьте формат XML файла (должен быть CommerceML 2)
- Убедитесь, что файл не поврежден
- Проверьте кодировку файла (должна быть UTF-8)

## Проверка работы

1. **В 1С:**
   - Выполните обмен данными
   - Проверьте сообщение о результате

2. **В Django админке:**
   - Перейдите в `Catalog` → `Sync logs`
   - Найдите последнюю запись
   - Проверьте статус и количество обработанных товаров

3. **На сайте:**
   - Проверьте, что товары появились/обновились
   - Убедитесь, что цены и остатки корректны

---

**Документ актуален на:** 2024 год

**Версия протокола:** CommerceML 2
