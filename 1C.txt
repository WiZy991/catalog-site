Протокол обмена с сайтом
Данный открытый протокол разработан компаниями «1С» и «1С-Битрикс».

Протокол используется штатной процедурой обмена коммерческими данными между системой «1С: Предприятие», с одной стороны, и системой управления сайтом, с другой стороны.

Функционально обмен делится на два блока:
выгрузка на сайт торговых предложений (каталогов продукции), данных об остатках на складах (с разбивкой и сводно), данных только о ценах и остатках (без описания номенклатуры);
обмен информацией о заказах.
Первый блок обеспечивает публикацию на сайте каталога номенклатурных позиций и данных. Второй блок необходим для передачи с сайта в систему «1С: Предприятие» информации о заказах интернет-магазина, и дальнейшую синхронизацию статусов и параметров заказов.

В обоих случаях инициатором обмена выступает система «1С: Предприятие». Обмен электронными документами осуществляется в соответствии с правилами и форматами, описанными в стандарте CommerceML 2.

При инициализации взаимодействия устанавливается HTTP соединение. Система «1С: Предприятие» запрашивает у сайта необходимые параметры, такие, как максимальный объем пакета, поддержка сжатия и др. На основании этих данных система 1С: Предприятие формирует XML сообщения и передает их на сайт.

Выгрузка на сайт
Данные для публикации на сайте выгружаются одним пакетом.

A. Начало сеанса
Выгрузка данных начинается с того, что система «1С: Предприятие» отправляет http-запрос следующего вида: 
http://<сайт>/<путь> /1c_exchange.php? type=catalog& mode=checkauth.

В ответ система управления сайтом передает системе «1С: Предприятие» три строки (используется разделитель строк «\n»):
слово «success»;
имя Cookie;
значение Cookie.
Примечание. Все последующие запросы к системе управления сайтом со стороны «1С: Предприятия» содержат в заголовке запроса имя и значение Cookie.

B. Запрос параметров от сайта
Далее следует запрос следующего вида: 
http://<сайт>/<путь> /1c_exchange.php? type=catalog& mode=init

В ответ система управления сайтом передает две строки:
zip=yes, если сервер поддерживает обмен в zip-формате —  в этом случае на следующем шаге файлы должны быть упакованы в zip-формате
или
zip=no — в этом случае на следующем шаге файлы не упаковываются и передаются каждый по отдельности.
file_limit=<число>, где <число> — максимально допустимый размер файла в байтах для передачи за один запрос. Если системе «1С: Предприятие» понадобится передать файл большего размера, его следует разделить на фрагменты.
C. Выгрузка на сайт файлов обмена
Затем «1С: Предприятие» запросами с параметрами вида 
http://<сайт>/<путь> /1c_exchange.php? type=catalog& mode=file& filename=<имя файла> 
выгружает на сайт файлы обмена в формате CommerceML 2, посылая содержимое файла или его части в виде POST.

В случае успешной записи файла система управления сайтом выдает строку «success».

D. Пошаговая загрузка данных
На последнем шаге по запросу из «1С: Предприятия» производится пошаговая загрузка данных по запросу с параметрами вида http://<сайт>/<путь> /1c_exchange.php? type=catalog& mode=import& filename=<имя файла>

Во время загрузки система управления сайтом может отвечать в одном из следующих вариантов.
Если в первой строке содержится слово «progress» — это означает необходимость послать тот же запрос еще раз. В этом случае во второй строке будет возвращен текущий статус обработки, объем  загруженных данных, статус импорта и т. д.
Если в ответ передается строка со словом «success», то это будет означать сообщение об успешном окончании обработки файла.
Примечание. Если в ходе какого-либо запроса произошла ошибка, то в первой строке ответа системы управления сайтом будет содержаться слово «failure», а в следующих строках — описание ошибки, произошедшей в процессе обработки запроса. Если произошла необрабатываемая ошибка уровня ядра продукта или sql-запроса, то будет возвращен html-код.

Примеры файлов выгрузки
Сведения о товарах в формате XML.



Настройка обмена данными в 1С:Управление торговлей 11
Работа с модулями
/
Модуль "Обмен данными"
/
Интеграция с 1С
Настройка обмена данными
Для включения обмена данными с сайтом перейдите в Администрирование - Обмен данными и отметьте флажок “Обмен данными с сайтами”.

 

Обмен данными с сайтамиРис. 1. Обмен данными с сайтами.
 
Далее нужно включить использование заказов клиентов. Для этого перейдите в Администрирование - Продажи и в разделе “Оптовые продажи” отметьте флажок “Заказы клиентов”.

 

Заказы клиентовРис. 2. Заказы клиентов.
 
После чего создайте типовое соглашение для выгрузки цен. Перейдите в Маркетинг - Типовые соглашения с клиентами. Создайте новое или измените существующее соглашение. Соглашение должно быть действующим, с пустым сегментом партнёров и доступно внешним пользователям.

 

Создание типового соглашения

Рис. 3. Создание типового соглашения.
 
Создание узла обмена с веб-сайтом
Чтобы создать узел обмена с сайтом, перейдите в Администрирование - Обмен данными и кликните ссылку “Узлы обмена с сайтами”. В открывшемся окне нажмите кнопку “Создать”.

 

Создание узла обмена с сайтомРис. 4. Создание узла обмена с сайтом.
 
Поля “Наименование” и “Код узла” заполняются автоматически при сохранении. При необходимости их можно задать самостоятельно. Следует отметить флажок “Выгрузка товаров”, если планируется выгрузка товаров на сайт и флажок “Обмен заказами”, если планируется загрузка заказов с сайта. Далее нужно указать адрес сайта, имя пользователя и пароль. Адрес сайта должен быть в следующем формате: “http://ваш_сайт/admin/exchange/auto/” (важно убедиться, что после слова “auto” стоит “/”).

Для проверки соединения можно воспользоваться кнопкой “Проверить соединение...”. Если все параметры указаны верно, то появится сообщение “Соединение успешно установлено”. В противном случае - нужно проверить правильность адреса и параметров доступа.

После того как будет сделана проверка соединения - укажите режим контроля изменений. В режиме “Полная выгрузка” выгружаются все товары и заказы, соответствующие условиям выгрузки. Режим “Выгружать только изменённые объекты” проводит автоматический контроль изменений, произошедших с момента последней удачной выгрузки. Все изменения выгружаются на сайт.

 

Параметры узла обмена с сайтом
Рис. 5. Параметры узла обмена с сайтом.

При необходимости можно настроить периодический обмен данными. Для этого установите флажок “Использовать периодический обмен данными”. После установки флажка автоматически откроется форма настройки расписания обмена:

 

Расписание обменаРис. 6. Расписание обмена.

Если флажки “Выгрузка товаров” и “Обмен заказами” отмечены - необходимо провести настройку выгрузки товаров и обмена заказами соответственно.

 

Настройка выгрузки товаров
Перейдите на вкладку “Выгрузка товаров” (данная вкладка доступна, если отмечен флажок “Выгрузка товаров” на вкладке “Основные настройки”).

 

Флажок "Выгрузка товаров"
Рис. 7. Флажок “Выгрузка товаров”.

На вкладке укажите организацию - владельца каталога (это организация, от имени которой происходит выгрузка на сайт) и коэффициент перерасчёта веса (используется при перерасчёта веса товаров из единиц, в которых указан вес в УТ в единицы, в которых вес учитывается на сайте). Установите флажок “Выгружать файлы изображений”, если планируется выгрузка картинок товаров на сайт. Если будет производиться выгрузка произвольных файлов, присоединённых к номенклатуре - установите флажок “Выгружать прочие файлы”. При необходимости построить классификатор групп товаров по справочнику “Виды номенклатуры” - установите флажок “Классифицировать по видам номенклатуры”. При не установленном флажке группы будут выгружаться из справочника “Номенклатура”.

Таблица каталогов заполняется также по необходимости. В ней содержатся строки, соответствующие информационному блоку на сайте.

 

Таблица каталоговРис. 8. Таблица каталогов.

В колонках “Каталог” и “Группы номенклатуры” задайте имя каталога и фильтр выгрузки групп соответственно. Состав выбираемых групп зависит от флажка “Классифицировать по видам номенклатуры”. Если данный флажок установлен, то группы выбираются из справочника “Виды номенклатуры”. Иначе, выбор происходит из справочника “Номенклатура”. В случае, если конкретные группы не выбраны (указано “Все”) - выгружаются все группы. Колонка “Идентификатор каталога” задаёт идентификатор, по которому устанавливается связь выгружаемых данных с конкретным информационным блоком на сайте.

Если требуется настроить отбор, нажмите кнопку “Настроить отбор”. При этом откроется форма настройки отбора для выбранного каталога. С помощью отбора устанавливаются ограничения по выгрузке товаров.

 

Настройка отбора
Рис. 9. Настройка отбора.

Настройка обмена заказами
Перейдите на вкладку “Обмен заказами” (данная вкладка доступна, если отмечен флажок “Обмен заказами” на вкладке “Основные настройки”).

 

Флажок "Обмен заказами"
Рис. 10. Флажок “Обмен заказами”.

Настройте способ идентификации контрагентов - это режим поиска контрагентов при загрузке заказов на сайт. Предоставляется два варианта поиска: по наименованию и по комбинации ИНН + КПП.

Внимание: По умолчанию в системе работает поиск по наименованию. Если Вам нужно сделать поиск по комбинации ИНН + КПП, то для обеспечения такой логики придётся кастомизировать шаблон выгрузки заказов.

Укажите виды номенклатуры Товар (с этим видом номенклатуры будут записываться новые товары) и Услуга (с этим видом номенклатуры будут записываться новые услуги). Укажите единицу измерения для новой номенклатуры. Создаваемые товары записываются с этой единицей измерения. По необходимости - заполните группу новой номенклатуры. В эту группу помещаются товары и услуги, создаваемые при загрузке заказов с сайта. Укажите соглашение, с которым будут создаваться документы “Заказ клиента”. Если это требуется - укажите организацию и менеджера, от имени которых будут создаваться данные документы.

Дополнительные параметры обмена заказами настраиваются на вкладке “Дополнительно”.

 

Вкладка "Дополнительно"
Рис. 11. Вкладка “Дополнительно”.

На данной вкладке Вы можете:

установить режим записи и проведения документов “Заказ клиента”;
настроить параметры отмены заказов (если заказ отменён, то соответствующая информация появится в УТ).
 

Параметры отмены заказов:

статус заказа “Отменён” - это значение статуса, получаемого с сайта (обычно равно “Отменён”);
поле “Причина отмены заказа” (содержит причину отмены, которая заполняется в соответствующем поле документа “Заказ клиента”);
соответствие статусов заказа (если соответствия настроены, при загрузке заказов будет проводиться попытка установки соответствующего статуса документа “Заказ клиента”).
Внимание: При каждом изменении статуса заказа в UMI.CMS для этого заказа устанавливается флаг "Выгружать заказ в 1С при следующем сеансе связи". При синхронизации выгружаются только заказы, для которых этот флаг установлен true. После выгрузки флаг снимается. При необходимости можно поставить флаг для заказа в модуле "Интернет-магазин" на вкладке Заказы, предварительно добавив отображение этого свойства в таблицу заказов.


Выполнение обмена данными
Запустить обмен данными вручную, можно нажав кнопку “Выполнить обмен данными” в форме узла, либо в форме списка узлов. По его окончании будет выдано соответствующее сообщение.

 

Кнопка "Выполнить обмен данными"
Рис. 12. Кнопка “Выполнить обмен данными”.

Чтобы процесс обмена запускался автоматически, настройте расписание автоматического обмена и сохраните настройки узла обмена данными. В том случае, если на сервере “1С: Предприятия” включено выполнение регламентных заданий, обмен будет происходить автоматически, по установленному расписанию. Если используется файловый вариант работы УТ, то для выполнения автоматического обмена должен быть запущен специальный сеанс, обрабатывающий регламентные задания.


Настройка обмена данными между 1С и django проектом
1С-Битрикс
*
Django
*
Python
*
Ожидает приглашения
Недавно заказчик попросил меня добавить в интернет-магазин, написанный на django, интеграцию с 1С. С 1С я до этого не работал, а добыть информацию в интернете для решения данной задачи оказалось для меня непросто. Поэтому я решил поделиться своим решением в этой статье.

Для обмена информацией между 1С и интернет-магазином в формате XML мы будем использовать единый стандарт обмена - CommerceML 2 standard. Для работы с CommerceML 2 standard я cмог найти единственную работающую библиотеку django-cml. Подробное описание установки библиотеки можно найти по ссылке Github репозитория библиотеки.

После установки библиотеки необходимо настроить 1С на обмен данных с интернет-магазином.

Заходим в 1С и переходим по следующему пути: "НСИ и администрирование" -> "обмен с сайтом".


Дальше переходим в "Настройки обмена с сайтом".


Дальше нажимаем на "создать", чтобы создать новый обмен.


Дальше необходимо заполнить раздел "Способ обмена данными". В полях "Имя пользователя" и "Пароль" вы указываете логин и пароль от админ панели django. В поле "Адрес сайта" необходимо указать строку в следующем формате:

"http://<сайт>/cml/exchange?type=catalog&mode=checkauth".


Дальше вы заполняете остальные разделы, указывая номенклатуры которые необходимо выгрузить на сайт. После заполнения всех разделов и успешного создания обмена необходимо нажать на "Выполнить обмен".


После завершения обмена с сайтом 1С выдаст сообщение. Я запрашивал у 1С номенклатуры, содержащие описание товаров и картинки. Описание товаров было выгружено в файле "import0_1.xml", а рядом картинки этих товаров.

