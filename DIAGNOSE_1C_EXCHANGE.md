# Диагностика обмена с 1С

## Проблема
1С сообщает, что обмен завершен успешно, но товары не появляются на сайте.

## Шаги диагностики

### 1. Проверка логов синхронизации в админ-панели

1. Зайдите в админ-панель Django: `/admin/`
2. Перейдите в раздел **Каталог → Логи синхронизации**
3. Проверьте последние записи:
   - **Статус** - должен быть "Успешно" или "Частично"
   - **Обработано товаров** - должно быть больше 0
   - **Создано товаров** - должно быть больше 0 (если товары новые)
   - **Обновлено товаров** - должно быть больше 0 (если товары существующие)
   - **Ошибок** - проверьте, есть ли ошибки

### 2. Проверка файлов обмена

Проверьте директорию `media/1c_exchange/`:
- Должны быть файлы XML от 1С (например, `import0_1.xml`, `offers0_1.xml`)
- Проверьте дату последнего изменения файлов

### 3. Проверка логов Django

Проверьте файл `logs/django.log` на наличие:
- Запросов от 1С (должны быть записи с "CommerceML запрос получен!")
- Ошибок при обработке файлов
- Сообщений о создании/обновлении товаров

### 4. Проверка URL в настройках 1С

В 1С адрес должен быть указан в формате:
```
http://ваш_сайт/cml/exchange?type=catalog&mode=checkauth
```

Или:
```
http://ваш_сайт/cml/exchange/?type=catalog&mode=checkauth
```

**Важно:** После слова `exchange` должен быть слэш `/` или параметры `?type=...`

### 5. Проверка авторизации

Убедитесь, что:
- Логин и пароль в 1С соответствуют пользователю Django с правами **staff**
- Пользователь активен в Django
- Проверка подключения в 1С проходит успешно

### 6. Запуск диагностического скрипта

Запустите скрипт диагностики:
```bash
python check_1c_exchange.py
```

Скрипт покажет:
- Настройки обмена
- Файлы в директории обмена
- Последние логи синхронизации
- Последние товары с external_id

## Возможные проблемы и решения

### Проблема 1: Файлы не сохраняются

**Симптомы:**
- В директории `media/1c_exchange/` нет файлов
- В логах нет записей о сохранении файлов

**Решение:**
1. Проверьте права доступа к директории `media/`
2. Убедитесь, что директория `media/1c_exchange/` создается автоматически
3. Проверьте логи Django на наличие ошибок при сохранении файлов

### Проблема 2: Файлы сохраняются, но не обрабатываются

**Симптомы:**
- Файлы есть в директории `media/1c_exchange/`
- Но в логах синхронизации нет записей или статус "Ошибка"

**Решение:**
1. Проверьте логи Django на наличие ошибок парсинга XML
2. Убедитесь, что файлы имеют правильный формат CommerceML 2
3. Проверьте, что в файлах есть элементы `<Каталог>` или `<ПакетПредложений>`

### Проблема 3: Товары не создаются из-за ошибок валидации

**Симптомы:**
- В логах синхронизации есть записи
- Но количество созданных товаров = 0
- Есть ошибки валидации

**Решение:**
1. Проверьте ошибки в логах синхронизации
2. Убедитесь, что в XML есть обязательные поля:
   - `Ид` (идентификатор товара)
   - `Наименование` (название товара)
3. Проверьте формат данных (цена должна быть числом, количество - целым числом)

### Проблема 4: Товары создаются, но не отображаются на сайте

**Симптомы:**
- В логах товары создаются/обновляются
- Но на сайте их нет

**Решение:**
1. Проверьте, что товары имеют `is_active=True`
2. Проверьте, что товары имеют категорию
3. Проверьте фильтры на странице каталога

## Улучшенное логирование

После обновления кода в `commerceml_views.py` логирование улучшено:
- Логируются все запросы от 1С
- Логируется структура XML при ошибках парсинга
- Логируется процесс обработки каждого товара
- Логируются ошибки валидации с деталями

## Проверка через админ-панель

1. Зайдите в **Каталог → Товары**
2. Отфильтруйте товары по полю `external_id` (не пустое)
3. Проверьте, есть ли товары с `external_id` из 1С
4. Если товары есть, но не отображаются - проверьте `is_active` и категорию

## Следующие шаги

1. Запустите обмен в 1С еще раз
2. Сразу после обмена проверьте:
   - Логи синхронизации в админ-панели
   - Файлы в `media/1c_exchange/`
   - Логи Django `logs/django.log`
3. Если проблема сохраняется - пришлите:
   - Скриншот логов синхронизации
   - Последние строки из `logs/django.log`
   - Пример XML файла из `media/1c_exchange/` (первые 50 строк)
