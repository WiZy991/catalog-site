# Проверка этапов обмена с 1С

## Проблема
1С подключается (checkauth работает), но товары не появляются.

## Этапы обмена CommerceML 2

1. **checkauth** - проверка авторизации ✅ (работает)
2. **init** - получение параметров
3. **file** - загрузка файлов
4. **import** - обработка файлов

## Диагностика

### После выполнения обмена в 1С проверьте:

```bash
# 1. Проверить логи всех этапов
tail -100 logs/django.log | grep -E "checkauth|init|file|import" | tail -20

# 2. Проверить файлы
ls -lah media/1c_exchange/

# 3. Проверить логи синхронизации
python manage.py shell -c "from catalog.models import SyncLog; print(f'Логов: {SyncLog.objects.count()}')"
```

### Что должно быть в логах:

Если обмен проходит полностью, должны быть записи:
1. `handle_checkauth вызван` - авторизация
2. `handle_init вызван` - получение параметров
3. `handle_file вызван: filename=...` - загрузка файлов (может быть несколько)
4. `handle_import вызван: filename=...` - обработка файлов (может быть несколько)

### Если в логах только checkauth:

**Проблема:** 1С не переходит к следующим этапам.

**Возможные причины:**
- Ошибка на этапе init
- Неправильные параметры в ответе init
- Проблема с cookie сессии

**Решение:**
- Проверьте логи на ошибки после checkauth
- Проверьте, что cookie передается в следующих запросах
- Проверьте ответ init (должен быть `zip=yes\nfile_limit=...`)

### Если в логах есть file, но нет import:

**Проблема:** Файлы загружаются, но не обрабатываются.

**Возможные причины:**
- Файлы не сохраняются
- Ошибка при обработке файлов
- 1С не переходит к этапу import

**Решение:**
- Проверьте, что файлы действительно сохраняются
- Проверьте логи на ошибки в handle_file
- Проверьте логи на ошибки в handle_import

### Если в логах есть import, но товары не создаются:

**Проблема:** Файлы обрабатываются, но товары не создаются.

**Возможные причины:**
- Товары не найдены в файле
- Ошибки валидации
- Ошибки при сохранении в БД

**Решение:**
- Проверьте логи синхронизации на ошибки
- Проверьте структуру XML файла
- Проверьте, что товары есть в файле

## Быстрая проверка

После обмена в 1С выполните:

```bash
# Проверить все этапы в логах
tail -200 logs/django.log | grep -E "checkauth|init|handle_file|handle_import" 

# Проверить файлы
ls -lt media/1c_exchange/ | head -10

# Проверить логи синхронизации
python manage.py shell
```

В shell:
```python
from catalog.models import SyncLog
logs = SyncLog.objects.all()[:3]
for log in logs:
    print(f"{log.created_at}: {log.filename} - обработано: {log.processed_count}, создано: {log.created_count}")
```

Это покажет, на каком этапе останавливается обмен.
