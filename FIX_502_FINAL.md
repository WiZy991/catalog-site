# Финальная диагностика 502 Bad Gateway

## ✅ Проверено:
- Синтаксис `services.py` - ОК
- Импорт модуля `services` - ОК

## Проблема не в коде!

Раз модуль импортируется, проблема скорее всего в:
1. Приложение не перезапустилось
2. Ошибка при запуске WSGI приложения
3. Проблема с конфигурацией веб-сервера

## Шаг 1: Проверьте конфигурацию Django

```bash
cd ~/onesimus/onesimus
source venv/bin/activate
python manage.py check
```

**Если есть ошибки:**
- Исправьте их согласно сообщениям
- Перезапустите: `touch tmp/restart.txt`

**Если ошибок нет:**
- Переходите к следующему шагу

## Шаг 2: Убедитесь, что приложение перезапустилось

```bash
cd ~/onesimus/onesimus

# Обновите файл перезапуска (обязательно!)
touch tmp/restart.txt

# Проверьте время последнего изменения
ls -la tmp/restart.txt

# Должно показать текущее время
```

**Важно:** После `touch tmp/restart.txt` подождите 30-60 секунд перед проверкой сайта!

## Шаг 3: Проверьте логи приложения (КРИТИЧНО!)

**Через панель управления Beget:**
1. Войдите в панель управления
2. Найдите раздел "Логи" или "Error logs"
3. Откройте последние логи (после последнего перезапуска)
4. Ищите ошибки, которые произошли при запуске приложения

**Через SSH:**
```bash
# Проверьте логи веб-сервера
tail -n 200 /var/log/nginx/error.log | grep -i "502\|error\|failed"

# Или для Apache
tail -n 200 /var/log/apache2/error.log | grep -i "502\|error\|failed"

# Проверьте логи Passenger (если используется)
tail -n 200 ~/logs/passenger.log

# Проверьте логи Django (если есть)
ls -la logs/
tail -n 200 logs/*.log 2>/dev/null
```

## Шаг 4: Проверьте WSGI конфигурацию

```bash
cd ~/onesimus/onesimus

# Проверьте файл wsgi.py
cat config/wsgi.py

# Должно быть:
# os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
```

## Шаг 5: Попробуйте запустить Django сервер вручную (для теста)

```bash
cd ~/onesimus/onesimus
source venv/bin/activate

# Попробуйте запустить сервер разработки (на другом порту)
python manage.py runserver 127.0.0.1:8001

# Если сервер запустился - Django работает
# Если есть ошибка - вы увидите её
```

**Внимание:** Не оставляйте этот сервер запущенным! Это только для диагностики.

## Шаг 6: Проверьте права доступа

```bash
cd ~/onesimus/onesimus

# Проверьте права на важные файлы
ls -la manage.py
ls -la config/wsgi.py
ls -la config/settings.py

# Должны быть права на чтение (минимум 644)
# Если нет - исправьте:
chmod 644 config/settings.py
chmod 644 config/wsgi.py
chmod 755 manage.py
```

## Шаг 7: Проверьте, что виртуальное окружение активировано на сервере

```bash
cd ~/onesimus/onesimus

# Проверьте, какая версия Python используется
which python
python --version

# Проверьте, что Django установлен
python -c "import django; print(django.get_version())"

# Проверьте путь к виртуальному окружению (если используется)
echo $VIRTUAL_ENV
```

## Шаг 8: Перезапустите через панель управления Beget

Если `touch tmp/restart.txt` не помогает:

1. Войдите в панель управления Beget
2. Перейдите в "Сайты" → выберите ваш сайт
3. Найдите кнопку "Перезапустить приложение" или "Restart"
4. Нажмите её
5. Подождите 30-60 секунд
6. Проверьте сайт

## Шаг 9: Проверьте использование ресурсов

502 может быть из-за нехватки ресурсов:

1. В панели управления Beget проверьте использование:
   - Памяти (RAM)
   - CPU
   - Места на диске

2. Если ресурсы на пределе:
   - Очистите логи
   - Удалите временные файлы
   - Обратитесь в поддержку Beget

## Что делать прямо сейчас:

1. **Выполните `python manage.py check`** - проверит конфигурацию
2. **Обновите `tmp/restart.txt`**: `touch tmp/restart.txt`
3. **Подождите 30-60 секунд**
4. **Проверьте логи** - это самое важное!
5. **Попробуйте перезапустить через панель управления Beget**

## Если ничего не помогает:

1. **Обратитесь в поддержку Beget** - они могут проверить логи на своей стороне
2. **Проверьте, не изменилась ли конфигурация веб-сервера** (nginx/apache)
3. **Убедитесь, что домен правильно настроен** в панели управления

## Важно помнить:

- После каждого изменения в `tmp/restart.txt` нужно ждать 30-60 секунд
- Логи покажут точную причину - обязательно проверьте их!
- 502 Bad Gateway означает, что веб-сервер не может связаться с Django приложением
- Раз код правильный, проблема скорее всего в конфигурации или процессе запуска
