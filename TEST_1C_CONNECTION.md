# Тестирование соединения с 1С

## Проблема
Запросы от 1С не доходят до Django - нет логов CommerceML.

## Диагностика

### 1. Проверка, что URL правильный в 1С

В настройках 1С должен быть указан URL:
```
http://onesim8n.beget.tech/cml/exchange/?type=catalog&mode=checkauth
```

⚠️ **Важно:** 
- Должен быть слэш перед `?` (`/cml/exchange/`)
- Не должно быть лишних символов

### 2. Тестовый запрос вручную (имитация 1С)

```bash
# Тест 1: checkauth (без авторизации - должен вернуть 401)
curl -v "http://onesim8n.beget.tech/cml/exchange/?type=catalog&mode=checkauth"

# Тест 2: checkauth (с авторизацией - должен вернуть success)
# Замените USERNAME и PASSWORD на реальные данные администратора Django
curl -v -u "USERNAME:PASSWORD" "http://onesim8n.beget.tech/cml/exchange/?type=catalog&mode=checkauth"

# После успешного checkauth получите cookie и используйте его:
# Тест 3: init (с cookie)
curl -v -b "1c_exchange_session=COOKIE_VALUE" "http://onesim8n.beget.tech/cml/exchange/?type=catalog&mode=init"
```

### 3. Проверка логов после тестового запроса

```bash
# Сразу после тестового запроса проверьте логи
tail -20 logs/django.log
```

Если в логах появились записи о CommerceML - значит функция работает, проблема в настройках 1С.

### 4. Проверка настроек 1С

В 1С проверьте:
1. **Адрес сайта** - должен быть точно: `http://onesim8n.beget.tech/cml/exchange/?type=catalog&mode=checkauth`
2. **Имя пользователя** - логин администратора Django
3. **Пароль** - пароль администратора Django
4. **Тип обмена** - должен быть "Каталог товаров"

### 5. Проверка логов веб-сервера (nginx)

Если есть доступ к логам nginx:

```bash
# Проверить access.log на запросы к /cml/exchange/
tail -100 /var/log/nginx/access.log | grep "cml/exchange"

# Проверить error.log на ошибки
tail -100 /var/log/nginx/error.log | grep -i "cml\|1c\|commerce"
```

### 6. Альтернатива - проверить через логи 1С

Если в 1С есть возможность посмотреть логи обмена:
- Проверьте, что соединение устанавливается
- Проверьте, на каком этапе останавливается обмен
- Проверьте сообщения об ошибках

## Возможные проблемы

### Проблема 1: Неправильный URL в 1С

**Решение:**
- Проверьте, что URL точно совпадает с указанным выше
- Убедитесь, что нет лишних пробелов или символов
- Попробуйте скопировать URL напрямую из браузера

### Проблема 2: Ошибка авторизации

**Решение:**
- Проверьте логин и пароль администратора Django
- Убедитесь, что пользователь имеет права администратора (`is_staff=True`)
- Попробуйте создать нового пользователя специально для 1С

### Проблема 3: Запросы блокируются

**Решение:**
- Проверьте настройки firewall
- Проверьте, что порт 80 открыт
- Проверьте логи nginx на блокировки

## Быстрая проверка

Выполните тестовый запрос с авторизацией:

```bash
# Замените на реальные данные
curl -v -u "admin:password" "http://onesim8n.beget.tech/cml/exchange/?type=catalog&mode=checkauth" 2>&1 | head -30
```

Затем сразу проверьте логи:

```bash
tail -10 logs/django.log
```

Если в логах появились записи - значит все работает, проблема в настройках 1С.
