# Полная документация API интеграции 1С с Django сайтом

## Для программиста 1С

---

## Содержание

1. [Общая информация](#общая-информация)
2. [Endpoints](#endpoints)
3. [Структура запроса](#структура-запроса)
4. [Поля товара](#поля-товара)
5. [Типы данных](#типы-данных)
6. [Правила валидации](#правила-валидации)
7. [Примеры запросов](#примеры-запросов)
8. [Структура ответа](#структура-ответа)
9. [Логика обработки товаров](#логика-обработки-товаров)
10. [Совместимость с существующими системами](#совместимость-с-существующими-системами)
11. [Обработка ошибок](#обработка-ошибок)
12. [Загрузка файлов](#загрузка-файлов)
13. [Рекомендации](#рекомендации)
14. [Контрольный список перед отправкой](#контрольный-список-перед-отправкой)
15. [Дополнительная информация](#дополнительная-информация)

---

## Общая информация

**Базовый URL:** `https://your-site.com` (замените на ваш домен)

**Метод аутентификации:** Токен авторизации

**Форматы данных:** JSON (для API), CSV/XML/JSON (для файлов)

**Кодировка:** UTF-8

**Content-Type:** `application/json; charset=utf-8`

---

## Endpoints

### 1. API синхронизация товаров

**URL:** `/api/1c/sync/`

**Метод:** `POST`

**Content-Type:** `application/json; charset=utf-8`

**Аутентификация:**
- В заголовке: `X-API-Key: ваш-токен`
- Или в теле запроса: поле `token` со значением токена

### 2. Загрузка файлов

**URL:** `/api/1c/upload/`

**Метод:** `POST`

**Content-Type:** `multipart/form-data`

**Аутентификация:**
- В заголовке: `X-API-Key: ваш-токен`

**Параметры:**
- `file` - файл для загрузки (CSV, XML или JSON)

---

## Структура запроса

### Корневой объект

```json
{
  "token": "строка-токена",
  "products": [
    {
      // Объект товара
    }
  ]
}
```

### Поля корневого объекта

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `token` | String | Да | Токен авторизации (должен совпадать с токеном на сервере) |
| `products` | Array | Да | Массив объектов товаров (минимум 1 товар) |

---

## Поля товара

### Обязательные поля

| Поле | Тип | Формат | Пример | Описание | Ограничения |
|------|-----|--------|--------|----------|-------------|
| `sku` | String | Текст | `"ART001"` | Артикул товара (уникальный идентификатор) | Максимум 100 символов. **Используется для поиска существующего товара в следующем порядке:** 1) по `external_id` (совместимость со старой системой), 2) по `article` (совместимость с админским импортом). Если товар не найден - создается новый с `external_id=sku` и `article=sku`. Это обеспечивает полную совместимость со всеми существующими способами импорта. |
| `name` | String | Текст | `"Товар 1"` | Название товара | Максимум 500 символов |
| `price` | Decimal | Число с точкой | `1000.00` | Цена товара | Должна быть >= 0. Разделитель дробной части - точка (.) |

### Опциональные поля

| Поле | Тип | Формат | Пример | По умолчанию | Описание | Ограничения |
|------|-----|--------|--------|--------------|----------|-------------|
| `description` | String | Текст | `"Описание"` | `""` | Полное описание товара | Без ограничений длины |
| `old_price` | Decimal | Число с точкой | `1500.00` | `null` | Старая цена (для отображения скидки) | Должна быть >= 0 и > `price`. Разделитель дробной части - точка (.) |
| `stock` | Integer | Целое число | `10` | `0` | Остаток на складе | Должен быть >= 0 |
| `category` | String | Текст | `"Категория 1"` | `null` | Название категории | Максимум 200 символов. Если категория не существует - она будет создана автоматически |
| `characteristics` | Array | Массив объектов | `[{...}]` | `[]` | Массив характеристик товара | Каждый элемент - объект с полями `name` и `value` |
| `is_active` | Boolean | true/false | `true` | `true` | Активен ли товар | `true` или `false` (без кавычек) |

### Поля характеристики товара

Если указано поле `characteristics`, каждый элемент массива должен быть объектом:

| Поле | Тип | Формат | Пример | Обязательное | Описание | Ограничения |
|------|-----|--------|--------|--------------|----------|-------------|
| `name` | String | Текст | `"Цвет"` | Да | Название характеристики | Максимум 200 символов, не может быть пустым |
| `value` | String | Текст | `"Красный"` | Да | Значение характеристики | Максимум 500 символов, не может быть пустым |

**Примечание:** При обновлении товара все старые характеристики удаляются и заменяются новыми из запроса.

---

## Типы данных

### String (Строка)

- **Формат:** Текст в кавычках
- **Примеры:** `"Текст"`, `"123"`, `""`
- **Кодировка:** UTF-8
- **Может быть:** пустой строкой `""` для опциональных полей
- **Не может быть:** `null` для обязательных полей

### Decimal (Число с дробной частью)

- **Формат:** Число с точкой как разделителем
- **Примеры:** `1000.00`, `1000.50`, `0.99`
- **НЕ используйте:** запятую как разделитель (`1000,00` - неверно)
- **Минимальное значение:** `0`
- **Разделитель дробной части:** точка (`.`)

### Integer (Целое число)

- **Формат:** Целое число без дробной части
- **Примеры:** `0`, `10`, `100`
- **Минимальное значение:** `0`
- **Не может быть:** отрицательным числом

### Boolean (Логическое значение)

- **Формат:** `true` или `false` (без кавычек)
- **Примеры:** `true`, `false`
- **НЕ используйте:** строки `"true"` или `"false"`, числа `1` или `0`
- **В JSON:** без кавычек

### Array (Массив)

- **Формат:** Список элементов в квадратных скобках `[]`
- **Примеры:** `[]`, `[1, 2, 3]`, `[{"name": "Цвет", "value": "Красный"}]`
- **Может быть:** пустым `[]`
- **Элементы:** разделяются запятой

---

## Правила валидации

### Обязательные поля

- `token` - должен присутствовать и совпадать с токеном на сервере
- `products` - должен быть массивом с минимум одним элементом
- В каждом товаре: `sku`, `name`, `price`

### Валидация цен

- ✅ `price` должна быть >= 0
- ✅ `old_price` (если указана) должна быть >= 0 и > `price`
- ✅ Разделитель дробной части - точка (`.`), не запятая
- ❌ Неверно: `"1000,00"` или `"1000"`
- ✅ Верно: `1000.00` или `1000`

### Валидация остатков

- ✅ `stock` должен быть >= 0
- ✅ Если не указан, используется значение `0`
- ✅ Должен быть целым числом

### Валидация характеристик

- ✅ Если указано поле `characteristics`, оно должно быть массивом
- ✅ Каждый элемент массива должен иметь поля `name` и `value`
- ✅ `name` не может быть пустым
- ✅ `value` не может быть пустым

### Валидация категории

- ✅ Если указана категория, она будет создана автоматически, если не существует
- ✅ Название категории обрезается до 200 символов

### Ограничения длины полей

| Поле | Максимальная длина |
|------|-------------------|
| `sku` | 100 символов |
| `name` | 500 символов |
| `description` | Без ограничений |
| `category` | 200 символов |
| `characteristics[].name` | 200 символов |
| `characteristics[].value` | 500 символов |

---

## Примеры запросов

### Пример 1: Минимальный запрос (только обязательные поля)

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00
    }
  ]
}
```

### Пример 2: Товар с ценой и остатком

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00,
      "stock": 10
    }
  ]
}
```

### Пример 3: Товар со скидкой

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00,
      "old_price": 1500.00,
      "stock": 10
    }
  ]
}
```

### Пример 4: Товар с категорией

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00,
      "category": "Категория 1"
    }
  ]
}
```

### Пример 5: Товар с характеристиками

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00,
      "characteristics": [
        {
          "name": "Цвет",
          "value": "Красный"
        },
        {
          "name": "Материал",
          "value": "Металл"
        }
      ]
    }
  ]
}
```

### Пример 6: Полный запрос со всеми полями

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "description": "Подробное описание товара",
      "price": 1000.00,
      "old_price": 1500.00,
      "stock": 10,
      "category": "Категория 1",
      "characteristics": [
        {
          "name": "Цвет",
          "value": "Красный"
        },
        {
          "name": "Материал",
          "value": "Металл"
        },
        {
          "name": "Размер",
          "value": "10x20x5 см"
        }
      ],
      "is_active": true
    }
  ]
}
```

### Пример 7: Массовая отправка товаров

```json
{
  "token": "ваш-секретный-токен",
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00,
      "stock": 5
    },
    {
      "sku": "ART002",
      "name": "Товар 2",
      "price": 2000.00,
      "stock": 10,
      "category": "Категория 2"
    },
    {
      "sku": "ART003",
      "name": "Товар 3",
      "price": 3000.00,
      "old_price": 3500.00,
      "stock": 0,
      "is_active": false
    }
  ]
}
```

---

## Структура ответа

### Успешный ответ (HTTP 200)

```json
{
  "status": "success",
  "processed": 10,
  "created": 3,
  "updated": 7,
  "errors": []
}
```

**Поля ответа:**

| Поле | Тип | Описание |
|------|-----|----------|
| `status` | String | Статус обработки: `"success"`, `"partial"` или `"error"` |
| `processed` | Integer | Общее количество товаров в запросе |
| `created` | Integer | Количество созданных товаров |
| `updated` | Integer | Количество обновленных товаров |
| `errors` | Array | Массив ошибок (пустой при успехе) |

### Частичный успех (HTTP 207)

```json
{
  "status": "partial",
  "processed": 10,
  "created": 3,
  "updated": 5,
  "errors": [
    "Товар #3: Ошибка валидации: цена обязательна",
    "Товар #7: Ошибка валидации: артикул обязателен"
  ]
}
```

**Когда возникает:** Часть товаров обработана успешно, но есть ошибки в других товарах.

### Ошибка (HTTP 400, 401, 500)

```json
{
  "status": "error",
  "message": "Описание ошибки",
  "errors": []
}
```

**HTTP коды ошибок:**

| Код | Описание |
|-----|----------|
| 200 | Успешно - все товары обработаны |
| 207 | Частичный успех - часть товаров обработана, есть ошибки |
| 400 | Ошибка валидации данных (неверный формат, отсутствуют обязательные поля) |
| 401 | Неверный токен авторизации |
| 500 | Внутренняя ошибка сервера |

---

## Логика обработки товаров

### Поиск товара

**Важно:** Система обеспечивает полную совместимость со всеми существующими способами импорта товаров.

Товар ищется по полю `sku` (артикул) в следующем порядке:
1. **Сначала ищется по `external_id`** (для совместимости со старой системой импорта `/api/1c/import/`)
2. **Если не найден, ищется по `article`** (для совместимости с админским импортом)
3. **Если товар найден** - он обновляется
4. **Если товар не найден** - создается новый с:
   - `external_id = sku`
   - `article = sku`

**Это гарантирует:**
- ✅ Совместимость со старой системой импорта (использует `external_id`)
- ✅ Совместимость с админским импортом (использует `article`)
- ✅ Отсутствие дубликатов товаров
- ✅ Правильное обновление существующих товаров независимо от способа их импорта

### Обновление полей

- Все указанные поля обновляются
- Поля, которые не указаны в запросе, остаются без изменений (кроме характеристик)
- При обновлении товара:
  - Если у товара не было `external_id`, он устанавливается равным `sku`
  - Если у товара не было `article` или он отличается от `sku`, он обновляется
- Характеристики полностью заменяются (старые удаляются, новые создаются)

### Обновление наличия

- Если `stock > 0` → статус наличия: "В наличии"
- Если `stock = 0` → статус наличия: "Нет в наличии"

### Обработка категории

- Если категория указана и существует - товар привязывается к ней
- Если категория указана, но не существует - категория создается автоматически
- Если категория не указана - товар остается без категории

---

## Совместимость с существующими системами

### Совместимость со старой системой импорта

**Старая система** (`/api/1c/import/`):
- Использует `external_id` для идентификации товаров
- Продолжает работать независимо от новой системы

**Новая система** (`/api/1c/sync/`):
- Сначала ищет товары по `external_id` (для совместимости)
- Затем ищет по `article` (если не найдено)
- При создании нового товара устанавливает и `external_id`, и `article`

**Результат:** Товары, импортированные через старую систему, будут правильно обновляться новой системой.

### Совместимость с админским импортом

**Админский импорт:**
- Использует `article` для идентификации товаров
- Работает через интерфейс админ-панели Django

**Новая система:**
- Ищет товары по `article`, если не находит по `external_id`
- При обновлении устанавливает `external_id` для будущей совместимости

**Результат:** Товары, импортированные через админку, будут правильно обновляться новой системой.

### Гарантии совместимости

✅ **Нет дубликатов** - система правильно находит существующие товары независимо от способа их импорта

✅ **Правильное обновление** - все поля обновляются корректно, включая установку `external_id` для товаров, импортированных через админку

✅ **Обратная совместимость** - старая система импорта продолжает работать без изменений

✅ **Единая логика** - все системы используют одинаковую логику обработки товаров

### Примеры работы системы

**Пример 1:** Товар импортирован через старую систему
```
База данных:
- external_id: "ART001"
- article: "ABC123"
```
Запрос с `sku="ART001"` → Найден по `external_id` → Обновлен ✅

**Пример 2:** Товар импортирован через админку
```
База данных:
- external_id: null
- article: "ART001"
```
Запрос с `sku="ART001"` → Не найден по `external_id` → Найден по `article` → Обновлен, установлен `external_id="ART001"` ✅

**Пример 3:** Новый товар
```
База данных:
- Товара нет
```
Запрос с `sku="NEW001"` → Не найден → Создан новый с `external_id="NEW001"` и `article="NEW001"` ✅

---

## Обработка ошибок

### Типы ошибок

1. **Ошибка авторизации (401)**
   - Причина: неверный токен
   - Решение: проверьте токен в запросе и на сервере

2. **Ошибка валидации (400)**
   - Причина: неверный формат данных, отсутствуют обязательные поля
   - Решение: проверьте структуру запроса и типы данных

3. **Ошибка обработки товара**
   - Причина: ошибка в данных конкретного товара
   - Решение: товар пропускается, остальные обрабатываются. Проверьте ошибки в ответе

### Рекомендации по обработке ошибок

1. Всегда проверяйте HTTP код ответа
2. Если код 200 или 207 - проверьте массив `errors` в ответе
3. Если есть ошибки - логируйте их для последующего исправления
4. При ошибке валидации конкретного товара - остальные товары все равно обрабатываются

---

## Загрузка файлов

### Endpoint

**URL:** `/api/1c/upload/`

**Метод:** `POST`

**Content-Type:** `multipart/form-data`

**Аутентификация:**
- В заголовке: `X-API-Key: ваш-токен`

### Параметры запроса

| Параметр | Тип | Обязательное | Описание |
|----------|-----|--------------|----------|
| `file` | File | Да | Файл для загрузки (CSV, XML или JSON) |

### Поддерживаемые форматы файлов

#### 1. CSV (`.csv`)

- Разделитель: запятая
- Кодировка: UTF-8 или CP1251
- Первая строка: заголовки колонок

**Маппинг колонок CSV:**

| Название колонки в CSV | Поле в системе |
|------------------------|----------------|
| `sku`, `артикул`, `article` | `sku` |
| `name`, `название`, `наименование` | `name` |
| `description`, `описание` | `description` |
| `price`, `цена` | `price` |
| `old_price`, `старая_цена` | `old_price` |
| `stock`, `остаток`, `количество` | `stock` |
| `category`, `категория` | `category` |
| `is_active`, `активен` | `is_active` |

**Примечание:** Остальные колонки будут интерпретированы как характеристики (название колонки = название характеристики, значение = значение характеристики).

#### 2. XML (`.xml`)

- Кодировка: UTF-8
- Структура: элементы `<product>` или `<товар>`

**Маппинг тегов XML:**

| Тег в XML | Поле в системе |
|-----------|----------------|
| `<sku>`, `<артикул>`, `<article>` | `sku` |
| `<name>`, `<название>`, `<наименование>` | `name` |
| `<description>`, `<описание>` | `description` |
| `<price>`, `<цена>` | `price` |
| `<old_price>`, `<старая_цена>` | `old_price` |
| `<stock>`, `<остаток>`, `<количество>` | `stock` |
| `<category>`, `<категория>` | `category` |
| `<is_active>`, `<активен>` | `is_active` |

**Пример структуры XML:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<products>
  <product>
    <sku>ART001</sku>
    <name>Товар 1</name>
    <price>1000.00</price>
    <stock>10</stock>
    <characteristics>
      <characteristic>
        <name>Цвет</name>
        <value>Красный</value>
      </characteristic>
    </characteristics>
  </product>
</products>
```

#### 3. JSON (`.json`)

- Кодировка: UTF-8
- Формат: массив товаров или объект с полем `products`

**Пример JSON файла:**

```json
{
  "products": [
    {
      "sku": "ART001",
      "name": "Товар 1",
      "price": 1000.00,
      "stock": 10
    }
  ]
}
```

Или просто массив:

```json
[
  {
    "sku": "ART001",
    "name": "Товар 1",
    "price": 1000.00
  }
]
```

### Формат ответа

Аналогичен endpoint `/api/1c/sync/` (см. раздел "Структура ответа")

---

## Рекомендации

### Для регулярной синхронизации

1. Отправляйте только измененные товары (по дате изменения)
2. Группируйте товары по категориям для лучшей производительности
3. Используйте batch-обработку (не более 100-200 товаров за раз)

### Для полной синхронизации

1. Разбейте все товары на части (по 100-200 штук)
2. Отправляйте каждую часть отдельным запросом
3. Проверяйте ответы и логируйте ошибки

### Ограничения производительности

- Максимальное количество товаров в одном запросе: рекомендуется до 1000 товаров
- При большом количестве товаров разбейте запрос на несколько частей
- Время обработки зависит от количества товаров
- Рекомендуется отправлять не более 100-200 товаров за раз
- Для больших объемов используйте несколько запросов

### Для обработки ошибок

1. Сохраняйте ответы API для анализа
2. При ошибках валидации - исправляйте данные и отправляйте повторно
3. Используйте логи на сервере для диагностики проблем

---

## Контрольный список перед отправкой

- [ ] Токен авторизации указан и корректен
- [ ] Поле `products` присутствует и является массивом
- [ ] В каждом товаре указаны обязательные поля: `sku`, `name`, `price`
- [ ] Типы данных соответствуют требованиям:
  - [ ] `price` - число (не строка)
  - [ ] `stock` - целое число (не строка)
  - [ ] `is_active` - логическое значение (не строка)
- [ ] `price` >= 0
- [ ] Если указан `old_price`, то `old_price` > `price`
- [ ] `stock` >= 0
- [ ] Если указаны `characteristics`, то каждый элемент имеет `name` и `value`
- [ ] Кодировка запроса: UTF-8
- [ ] Content-Type: `application/json; charset=utf-8`

---

## Дополнительная информация

### Логирование на сервере

Все запросы логируются в админ-панели Django:
- Раздел: `Catalog` → `Sync logs`
- Доступ: `/admin/catalog/synclog/`

В логах сохраняется:
- Дата и время запроса
- IP адрес отправителя
- Тип операции (API синхронизация или загрузка файла)
- Количество обработанных товаров
- Количество созданных товаров
- Количество обновленных товаров
- Список ошибок (если есть)
- Время обработки

### Уведомления об ошибках

При наличии ошибок система автоматически отправляет email администратору (если настроен `MANAGER_EMAIL` в настройках сервера).

### Важные замечания о совместимости

**Как система находит товары:**

При отправке товара с `sku="ART001"` система выполняет поиск в следующем порядке:

1. **Поиск по `external_id`**
   - Используется для совместимости со старой системой импорта (`/api/1c/import/`)
   - Если товар найден → обновляется
   - Если не найден → переход к шагу 2

2. **Поиск по `article`**
   - Используется для совместимости с админским импортом
   - Если товар найден → обновляется, устанавливается `external_id` (если не было)
   - Если не найден → переход к шагу 3

3. **Создание нового товара**
   - Создается новый товар с `external_id=sku` и `article=sku`
   - Это обеспечивает совместимость для будущих обновлений

**Гарантии:**

✅ **Нет дубликатов** - система всегда находит существующие товары независимо от способа их импорта

✅ **Обратная совместимость** - товары, импортированные через старую систему, правильно обновляются

✅ **Совместимость с админкой** - товары, импортированные через админку, правильно обновляются

✅ **Единая логика** - все системы используют одинаковую логику обработки

---

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи синхронизации в админ-панели
2. Проверьте формат данных запроса
3. Убедитесь, что токен авторизации корректен
4. Обратитесь к администратору сайта с описанием проблемы

---

## Краткая справка по типам данных

| Тип | Формат | Пример | Важно |
|-----|--------|--------|-------|
| String | `"текст"` | `"ART001"` | В кавычках, UTF-8 |
| Decimal | `число.число` | `1000.00` | Точка как разделитель |
| Integer | `число` | `10` | Целое число, >= 0 |
| Boolean | `true`/`false` | `true` | Без кавычек |
| Array | `[элементы]` | `[{...}]` | Квадратные скобки |

---

## Визуальная схема структуры

```
Request
│
├─► token: "строка-токена"
│
└─► products: [
      │
      ├─► Product 1 {
      │     ├─► sku: "ART001" (обязательно)
      │     │     └─► Используется для поиска:
      │     │         1. По external_id (совместимость со старой системой)
      │     │         2. По article (совместимость с админским импортом)
      │     │         3. Если не найден → создается новый с external_id=sku и article=sku
      │     │
      │     ├─► name: "Товар 1" (обязательно)
      │     ├─► price: 1000.00 (обязательно)
      │     ├─► description: "Описание" (опционально)
      │     ├─► old_price: 1500.00 (опционально)
      │     ├─► stock: 10 (опционально)
      │     ├─► category: "Категория 1" (опционально)
      │     ├─► is_active: true (опционально)
      │     │
      │     └─► characteristics: [ (опционально)
      │           ├─► { name: "Цвет", value: "Красный" }
      │           └─► { name: "Материал", value: "Металл" }
      │         ]
      │   }
      │
      └─► Product 2 { ... }
    ]
```

## Логика поиска и обновления товара (детально)

```
Запрос товара с sku="ART001"
│
├─► Шаг 1: Поиск по external_id="ART001"
│   ├─► Найден? → Обновить существующий товар
│   └─► Не найден? → Перейти к шагу 2
│
├─► Шаг 2: Поиск по article="ART001"
│   ├─► Найден? → Обновить существующий товар
│   │              + Установить external_id="ART001" (если не было)
│   └─► Не найден? → Перейти к шагу 3
│
└─► Шаг 3: Создать новый товар
    ├─► external_id = "ART001"
    ├─► article = "ART001"
    └─► Остальные поля из запроса
```

---

**Документ актуален на:** 2024 год

**Версия API:** 1.0

**Последнее обновление:** Исправлена логика поиска товаров для полной совместимости со всеми существующими способами импорта. Система теперь:
- Ищет товары сначала по `external_id` (совместимость со старой системой `/api/1c/import/`)
- Затем ищет по `article` (совместимость с админским импортом)
- При создании устанавливает оба поля (`external_id` и `article`) для будущей совместимости
- Гарантирует отсутствие дубликатов и правильное обновление всех товаров независимо от способа их первоначального импорта
